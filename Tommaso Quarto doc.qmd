---
title: "Data Project"
author: "Tommaso Reali"
format: html
editor: visual
---

```{r}
library(here)
library(ggplot2)
library(dplyr)
library(vroom)
```

##Dowload data

```{r}
here::i_am("Data-Management-Final-Project.Rproj")
```

Description of how to get the data sets

To get the data of the CHR&R, download each file per year seperately

Link: "https://www.countyhealthrankings.org/health-data/methodology-and-sources/data-documentation/national-data-documentation-2010-2023"

To get the education data from the census bureau: Select all of the counties as variables, pick the variable you want to pick (in this case pick the education attainment) and download the data for all the years you are interested in

Link: "https://data.census.gov/table?q=S1501:+Educational+Attainment&g=010XX00US\$0500000_040XX00US01\$0500000"

```{r}
health2020 <- vroom(here("Data", "2020health.csv"))
health2021 <- vroom(here("Data", "2021health.csv"))
health2022 <- vroom(here("Data", "2022health.csv"))
health2023 <- vroom(here("Data", "2023health.csv"))
education2020 <- vroom(here("Data", "ACSST5Y2020.S1501-Data.csv"))
education2021 <- vroom(here("Data", "ACSST5Y2021.S1501-Data.csv"))
education2022 <- vroom(here("Data", "ACSST5Y2022.S1501-Data.csv"))
education2023 <- vroom(here("Data", "ACSST5Y2023.S1501-Data.csv"))

```

## Changes made to health data

## variables names to keep in dataset health:

% Severe Housing Problems
Income Ratio
% Unemployed
Mental Health Provider Rate
Teen Birth Rate
% Excessive Drinking
% Smokers
% Single-Parent Households

### Changes for health2020

```{r}
#replace wrong column names with first row:
new_names <- as.character(health2020[1, ])
colnames(health2020) <- new_names
health2020 <- health2020[-1, ]

```


```{r}
#remove all the columns which are not usefull (use the same technique for the other years datasets)

cols_health_2020 <- c(
  "FIPS",
  "State",
  "County",
  "% Severe Housing Problems",
  "Income Ratio",
  "% Unemployed",
  "80th Percentile Income",
  "% Children in Poverty",
  "Mental Health Provider Rate",
  "Teen Birth Rate",
  "% Excessive Drinking",
  "% Smokers",
  "% Single-Parent Households"
)

health2020 <- health2020 %>%
  select(all_of(cols_health_2020))


```

```{r}
#look at NA values and clean if they are in State, county columns
colSums(is.na(health2020))

health2020 %>%
  filter(is.na(County))

#replace NA values for county by "Average"
health2020 <- health2020 %>%
  mutate(
    County = ifelse(is.na(County), "Average", County)
  )

```


```{r}
#convert to numeric columns the ones that need it

health2020 <- health2020 %>%
  mutate(across(
    -c(FIPS, State, County),
    ~ as.numeric(gsub(",", ".", .x))
  ))

```

## Changes for Health2021

```{r}
#replace wrong column names with first row:
new_names <- as.character(health2021[1, ])
colnames(health2021) <- new_names
health2021 <- health2021[-1, ]

```


```{r}
#remove all the columns which are not usefull 

cols_health_2021 <- c(
  "FIPS",
  "State",
  "County",
  "% Severe Housing Problems",
  "Income Ratio",
  "% Unemployed",
  "80th Percentile Income",
  "% Children in Poverty",
  "Mental Health Provider Rate",
  "Teen Birth Rate",
  "% Excessive Drinking",
  "% Smokers",
  "% Children in Single-Parent Households"
)

health2021 <- health2021 %>%
  select(all_of(cols_health_2021))


```

```{r}
#look at NA values and clean if they are in State, county columns
colSums(is.na(health2021))

health2021 %>%
  filter(is.na(County))

#replace NA values for county by "Average"
health2021 <- health2021 %>%
  mutate(
    County = ifelse(is.na(County), "Average", County)
  )

```

```{r}
#convert to numeric columns the ones that need it

health2021 <- health2021 %>%
  mutate(across(
    -c(FIPS, State, County),
    ~ as.numeric(gsub(",", ".", .x))
  ))

```


## Changes for Health2022

```{r}
#replace wrong column names with first row:
new_names <- as.character(health2022[1, ])
colnames(health2022) <- new_names
health2022 <- health2022[-1, ]

```


```{r}
#remove all the columns which are not usefull 

## check if health2022 has the same variable names as 2021 and 2020

cols_health_2020 %in% names(health2022)
cols_health_2021 %in% names(health2022)

#create a vector for health2022 so we can select the columns we want

cols_health_2022 <- c(
  "FIPS",
  "State",
  "County",
  "% Severe Housing Problems",
  "Income Ratio",
  "% Unemployed",
  "80th Percentile Income",
  "% Children in Poverty",
  "Mental Health Provider Rate",
  "Teen Birth Rate",
  "% Excessive Drinking",
  "% Smokers",
  "% Children in Single-Parent Households"
)

health2022 <- health2022 %>%
  select(all_of(cols_health_2022))


```

```{r}
#look at NA values and clean if they are in State, county columns
colSums(is.na(health2022))

health2022 %>%
  filter(is.na(County))

#replace NA values for county by "Average"
health2022 <- health2022 %>%
  mutate(
    County = ifelse(is.na(County), "Average", County)
  )

```

```{r}
#convert to numeric columns the ones that need it

health2022 <- health2022 %>%
  mutate(across(
    -c(FIPS, State, County),
    ~ as.numeric(gsub(",", ".", .x))
  ))

```

## Changes for Health2023

```{r}
#replace wrong column names with first row:
new_names <- as.character(health2023[1, ])
colnames(health2023) <- new_names
health2023 <- health2023[-1, ]

```


```{r}
#remove all the columns which are not usefull 

## check if health2022 has the same variable names as 2021 and 2020

cols_health_2020 %in% names(health2023)
cols_health_2021 %in% names(health2023)
cols_health_2022 %in% names(health2023)

#create a vector for health2022 so we can select the columns we want

cols_health_2023 <- c(
  "FIPS",
  "State",
  "County",
  "% Severe Housing Problems",
  "Income Ratio",
  "% Unemployed",
  "80th Percentile Income",
  "% Children in Poverty",
  "Mental Health Provider Rate",
  "Teen Birth Rate",
  "% Excessive Drinking",
  "% Adults Reporting Currently Smoking",
  "% Children in Single-Parent Households"
)

health2023 <- health2023 %>%
  select(all_of(cols_health_2023))


```

```{r}
#look at NA values and clean if they are in State, county columns
colSums(is.na(health2023))

health2023 %>%
  filter(is.na(County))

#replace NA values for county by "Average"
health2023 <- health2023 %>%
  mutate(
    County = ifelse(is.na(County), "Average", County)
  )

```

```{r}
#convert to numeric columns the ones that need it

health2023 <- health2023 %>%
  mutate(across(
    -c(FIPS, State, County),
    ~ as.numeric(gsub(",", ".", .x))
  ))

```

## Changes made for Education data

### Changes for education2020

```{r}
#replace wrong column names with first row:
new_names_education <- as.character(education2020[1, ])
colnames(education2020) <- new_names_education
education2020 <- education2020[-1, ]
```


```{r}
#remove useless columns
education2020 <- education2020 %>%
  select(-contains("Margin of Error", ignore.case = TRUE))
education2020 <- education2020 %>%
  select(-contains("Total", ignore.case = TRUE))
education2020 <- education2020 %>%
  select(-contains("Estimate!!Male!!", ignore.case = TRUE))
education2020 <- education2020 %>%
  select(-contains("Estimate!!Female!!", ignore.case = TRUE))

```



```{r}
#easier code for directly deleting all the rows in a single code 
education2020 <- education2020 %>%
  select(
    -matches("Margin of Error|Total|Estimate!!Male!!|Estimate!!Female!!",
             ignore.case = TRUE)
  )
```

```{r}
# remove columns that are ONLY "(X)" (ignoring NAs)
education2020 <- education2020 %>%
  select(
    where(~ !all(.x == "(X)" | is.na(.x)))
  )
```


```{r}
#remove also percent of females and percent of males in this column (if you want), this code can be kept or deleted depending on our decision to keep Percentage Female, PErcentage Male.
education2020 <- education2020 %>%
  select(
    -matches("Estimate!!Percent Male!!|Estimate!!Percent Female!!",
             ignore.case = TRUE)
  )
```

```{r}
#convert to numeric columns the ones that need it

education2020 <- education2020 %>%
  mutate(across(
    -c(Geography, `Geographic Area Name`),
    ~ suppressWarnings(as.numeric(.x))
  ))

```

## Changes for education 2021

```{r}
#replace wrong column names with first row:
new_names_education <- as.character(education2021[1, ])
colnames(education2021) <- new_names_education
education2021 <- education2021[-1, ]
```


```{r}
#remove useless columns
education2021 <- education2021 %>%
  select(-contains("Margin of Error", ignore.case = TRUE))
education2021 <- education2021 %>%
  select(-contains("Total", ignore.case = TRUE))
education2021 <- education2021 %>%
  select(-contains("Estimate!!Male!!", ignore.case = TRUE))
education2021 <- education2021 %>%
  select(-contains("Estimate!!Female!!", ignore.case = TRUE))

```



```{r}
#easier code for directly deleting all the rows in a single code 
education2021 <- education2021 %>%
  select(
    -matches("Margin of Error|Total|Estimate!!Male!!|Estimate!!Female!!",
             ignore.case = TRUE)
  )
```

```{r}
# remove columns that are ONLY "(X)" (ignoring NAs)
education2021 <- education2021 %>%
  select(
    where(~ !all(.x == "(X)" | is.na(.x)))
  )
```


```{r}
#remove also percent of females and percent of males in this column (if you want), this code can be kept or deleted depending on our decision to keep Percentage Female, PErcentage Male.
education2021 <- education2021 %>%
  select(
    -matches("Estimate!!Percent Male!!|Estimate!!Percent Female!!",
             ignore.case = TRUE)
  )
```

```{r}
#convert to numeric columns the ones that need it

education2021 <- education2021 %>%
  mutate(across(
    -c(Geography, `Geographic Area Name`),
    ~ suppressWarnings(as.numeric(.x))
  ))

```

## Changes for education 2022

```{r}
#replace wrong column names with first row:
new_names_education <- as.character(education2022[1, ])
colnames(education2022) <- new_names_education
education2022 <- education2022[-1, ]
```


```{r}
#remove useless columns
education2022 <- education2022 %>%
  select(-contains("Margin of Error", ignore.case = TRUE))
education2022 <- education2022 %>%
  select(-contains("Total", ignore.case = TRUE))
education2022 <- education2022 %>%
  select(-contains("Estimate!!Male!!", ignore.case = TRUE))
education2022 <- education2022 %>%
  select(-contains("Estimate!!Female!!", ignore.case = TRUE))

```



```{r}
#easier code for directly deleting all the rows in a single code 
education2022 <- education2022 %>%
  select(
    -matches("Margin of Error|Total|Estimate!!Male!!|Estimate!!Female!!",
             ignore.case = TRUE)
  )
```

```{r}
# remove columns that are ONLY "(X)" (ignoring NAs)
education2022 <- education2022 %>%
  select(
    where(~ !all(.x == "(X)" | is.na(.x)))
  )
```


```{r}
#remove also percent of females and percent of males in this column (if you want), this code can be kept or deleted depending on our decision to keep Percentage Female, PErcentage Male.
education2022 <- education2022 %>%
  select(
    -matches("Estimate!!Percent Male!!|Estimate!!Percent Female!!",
             ignore.case = TRUE)
  )
```

```{r}
#convert to numeric columns the ones that need it

education2022 <- education2022 %>%
  mutate(across(
    -c(Geography, `Geographic Area Name`),
    ~ suppressWarnings(as.numeric(.x))
  ))

```

## Changes for education 2023

```{r}
#replace wrong column names with first row:
new_names_education <- as.character(education2023[1, ])
colnames(education2023) <- new_names_education
education2023 <- education2023[-1, ]
```


```{r}
#remove useless columns
education2023 <- education2023 %>%
  select(-contains("Margin of Error", ignore.case = TRUE))
education2023 <- education2023 %>%
  select(-contains("Total", ignore.case = TRUE))
education2023 <- education2023 %>%
  select(-contains("Estimate!!Male!!", ignore.case = TRUE))
education2023 <- education2023 %>%
  select(-contains("Estimate!!Female!!", ignore.case = TRUE))

```



```{r}
#easier code for directly deleting all the rows in a single code 
education2023 <- education2023 %>%
  select(
    -matches("Margin of Error|Total|Estimate!!Male!!|Estimate!!Female!!",
             ignore.case = TRUE)
  )
```

```{r}
# remove columns that are ONLY "(X)" (ignoring NAs)
education2023 <- education2023 %>%
  select(
    where(~ !all(.x == "(X)" | is.na(.x)))
  )
```


```{r}
#remove also percent of females and percent of males in this column (if you want), this code can be kept or deleted depending on our decision to keep Percentage Female, PErcentage Male.
education2023 <- education2023 %>%
  select(
    -matches("Estimate!!Percent Male!!|Estimate!!Percent Female!!",
             ignore.case = TRUE)
  )
```

```{r}
#convert to numeric columns the ones that need it

education2023 <- education2023 %>%
  mutate(across(
    -c(Geography, `Geographic Area Name`),
    ~ suppressWarnings(as.numeric(.x))
  ))

```

What is left to do for the Data cleaning part: 
- Separate the county and state in two separate columns
- Look into the issue of spec() why does it read NULL instead of specifying the columns of the data
- Remove the puerto rico variables, However this can be done just by matching the datasets
- Append the datasets to eachother so that there is only one dataset for each datasets


## Description of variables

variables of Interest

- Adult smoking (in percentage of total of population of adults): This variable describes the reported rate of current daily smokers in the population of the county.

- Excessive drinking: This variable describes the self-reported rate of excessive drinkers of the population in the county.

- Teen births: This variable describes the amount of teen births per 1000 females aged 15-19.

Main variable

- Education level (percent of 25 > year olds that have a Bachelors degree minimum): This variable describes the percentage of 25 year olds or older that have a diploma for a Bachelors degree or higher. 

Control variables to complete model: 

- Unemployment: This variable describes the unemployment rate in the county. Unemployed people are 16 years old or older and are actively looking for work. 

- Income Inequality: This variable describes the income inequality levels, computed as the ratio of income at the 80th percentile over the income at the 20th percentile. 

- Severe Housing Problems: this variable describes the percentage of households that have at least one of the 4 reported housing problems: high housing costs, overcrowding, lack of kitchen or plumbing facilities.

- Children in single parent households: This variable describes the percentage of children that grow up in single parent households currently.

- Mental health providers: This variable describes the rate of mental health providers per 100000 inhabitants. 

